#!/bin/bash

#  dvbserver-monitor
#
#  http server. IP TV proxy
#  Uses mumudvb to get video/audio channels from several dvb cards.
#
#  When a channel is required,
#  dvbserver starts mumudvb sessions to any available dvb adapter
#  and redirects clients to the corresponding http stream.
#  Also, ends the mumudvb sessions at client disconnection.
#
#  $Revision: 1.2 $
#
#  Copyright (C) 2023-2023 Jordi Pujol <jordipujolp AT gmail DOT com>
#
#  This program is free software; you can redistribute it and/or modify
#  it under the terms of the GNU General Public License as published by
#  the Free Software Foundation; either version 3, or (at your option)
#  any later version.
#
#  This program is distributed in the hope that it will be useful,
#  but WITHOUT ANY WARRANTY; without even the implied warranty of
#  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#  GNU General Public License for more details.
#
#  You should have received a copy of the GNU General Public License
#  along with this program; if not, write to the Free Software
#  Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.
#************************************************************************

_exit() {
	trap - EXIT INT
	set +o errexit +o nounset -o pipefail +o noglob
	echo "exit" >&2
	echo >&2
	wait || :
}

set -o errexit -o nounset -o pipefail +o noglob +o noclobber

# global adapter*_ config*_ PortHttp
# local TMPDIR portHttp config dvbtype conffile tmpconffile adapter card tuner pid
# parms:
portHttp="${1}"

TMPDIR="/var/log/dvbserver/"
. "${TMPDIR}vars"
let "config=portHttp-PortHttp,1"
exec > "${TMPDIR}log-${config}.txt" 2>&1
set -x
eval dvbtype=\"\${config${config}_dvbtype:-}\"
eval conffile=\"\${config${config}_conffile:-}\"

pid="0"
while read -r adapter; do
	eval card=\"\${adapter${adapter}_card:-}\"
	eval tuner=\"\${adapter${adapter}_tuner:-}\"
	pid="$(lsof -wt "/dev/dvb/adapter${card}/frontend${tuner}")" || \
		break
done < <(set | \
sed -nre "/^adapter([[:digit:]]+)_dvbtype=${dvbtype}/s//\1/p")

[ -z "${pid}" ] || \
	exit 0

tmpconffile="${TMPDIR}${portHttp}.conf"
sed -re "/port_http=.*/s//port_http=$((portHttp+500))/" \
	-e "/card=.*/s//card=${card}/" \
	-e "/tuner=.*/s//tuner=${tuner}/" \
	< "${conffile}" > "${tmpconffile}"
((/usr/bin/mumudvb -d -c "${tmpconffile}" > "${TMPDIR}log-${config}-mumudvb.txt" 2>&1) &)

((
# wait for daemon start,
# monitor communication while connected
while sleep 60;
[ -n "$(ss --no-header --numeric --tcp \
state connected sport $((portHttp+500)) )" ]; do
	:
done
# stop mumudvb when idle
kill -s TERM ${pid} 2> /dev/null || :
wait ${pid} || :
) &)

sleep 2
exit 0
